<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Deep Reinforcement Learning" href="06-Deep%20Reinforcement%20Learning.html" /><link rel="prev" title="CPU Acceleration" href="04-CPU%20Acceleration.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>MNIST Classification - RLtools Documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="_static/overrides.css?v=ca018f06" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #639694;
  --color-brand-content: #639694;
  --color-admonition-background: orange;
  --sidebar_hide_name: True;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">RLtools Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/banner.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">RLtools Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="01-Containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-Multiple%20Dispatch.html">Multiple Dispatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-Deep%20Learning.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-CPU%20Acceleration.html">CPU Acceleration</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">MNIST Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-Deep%20Reinforcement%20Learning.html">Deep Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-The%20Loop%20Interface.html">The Loop Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="08-Custom%20Environment.html">Custom Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="09-TinyRL.html">TinyRL: A Python Interface for RLtools</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="MNIST-Classification">
<h1>MNIST Classification<a class="headerlink" href="#MNIST-Classification" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://mybinder.org/v2/gh/rl-tools/documentation/binder?labpath=05-MNIST%20Classification.ipynb"><img alt="Binder" src="https://mybinder.org/badge_logo.svg" /></a></p>
<p>In this tutorial we train a simple (fully-connected) model to classify handwritten digits from the MNIST dataset which contains <span class="math notranslate nohighlight">\(28 \times28\)</span> grayscale images like the following:</p>
<div align="center"><p><img alt="Examples from the MNIST handwritten digit dataset (image from Wikipedia by user Suvanjanprasai)" class="no-scaled-link" src="_images/mnist.png" style="height: 200px;" /></p>
</div><p>We flatten the 2D images to <span class="math notranslate nohighlight">\(28 \times 28 = 784\)</span> dimensional input vectors.</p>
<p>To train this model we first include the CPU operations (CPU implementations of primitive operations). Next, we include the CPU operations for all data structures in <code class="docutils literal notranslate"><span class="pre">nn</span></code> (we are mainly interested in the CPU operations of dense layers). We need to include these before including the operations of the models because the latter build upon the former, hence they should be defined apriori. Finally, we include the persistence operations for the containers which allows us to persist matrices, layers,
models, etc. to disk in the form of <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> files. In this tutorial, we are only interested in loading the MNIST dataset from an <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> file. The persistence functions are the only part that has an external dependency in the form of <code class="docutils literal notranslate"><span class="pre">highfive</span></code> a header-only C++ wrapper for the <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> API (which in turn is a requirement of <code class="docutils literal notranslate"><span class="pre">highfive</span></code>).</p>
<p>As described in <a class="reference internal" href="04-CPU%20Acceleration.html"><span class="doc">CPU Acceleration</span></a> we will use the OpenBLAS backend to speed up the training (and inference).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define RL_TOOLS_BACKEND_ENABLE_OPENBLAS</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/operations/cpu_mux.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/nn/operations_cpu_mux.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/nn_models/operations_cpu.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/containers/persist.h&gt;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">rlt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">rl_tools</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>To be able to open a <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> file and load datasets contained in it we include the <code class="docutils literal notranslate"><span class="pre">highfive</span></code> File API in the main code as well:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;highfive/H5File.hpp&gt;</span>
</pre></div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">highfive</span></code> is header-only we only need to link <code class="docutils literal notranslate"><span class="pre">hdf5</span></code> for cling to be able to use it:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma cling load(&quot;hdf5&quot;)</span>
<span class="cp">#pragma cling load(&quot;openblas&quot;)</span>
</pre></div>
</div>
</div>
<p>Next, we define the usual types:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">DEVICE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">devices</span><span class="o">::</span><span class="n">DEVICE_FACTORY</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">devices</span><span class="o">::</span><span class="n">DefaultCPUSpecification</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>For the MNIST classification, we are using a supervised training setup with a fully-connected neural network. The fully-connected network we are using consists of one input layer (<span class="math notranslate nohighlight">\(784\)</span> dimensional, one hidden layer (<span class="math notranslate nohighlight">\(50\)</span> dimensional), and one output layer (<span class="math notranslate nohighlight">\(10\)</span> dimensional). Since we like our health, we stick with a (mini) batch size of <span class="math notranslate nohighlight">\(32\)</span>:</p>
<div align="center"><p><img alt="Screenshot of a tweet by Yann LeCun: Training with large minibatches is bad for your health." src="_images/batch_size.png" /></p>
</div><p>Furthermore, we use <span class="math notranslate nohighlight">\(ReLU\)</span> non-linearities for the hidden activations (output of the input and hidden layer) and no non-linearity for the output activations. Note that we need to define the dataset size apriori to stick to our design principle of having the size of all loops and data structures be known at compile time. Normally, the size of datasets in <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> files can vary and programs loading them can adapt. Theoretically, this is a minor limitation of <strong>RLtools</strong> but we did not find
it to be restricting practically.</p>
<p>More importantly, itâ€™s bad for your test error.
Friends dont let friends use minibatches larger than 32.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">height<span class="colon">:</span></dt>
<dd class="field-odd"><p>200</p>
</dd>
<dt class="field-even">class<span class="colon">:</span></dt>
<dd class="field-even"><p>no-scaled-link</p>
</dd>
</dl>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">BATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">NUM_EPOCHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">INPUT_DIM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">28</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">OUTPUT_DIM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">NUM_LAYERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">HIDDEN_DIM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">ACTIVATION_FUNCTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">activation_functions</span><span class="o">::</span><span class="n">RELU</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">ACTIVATION_FUNCTION_OUTPUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">activation_functions</span><span class="o">::</span><span class="n">IDENTITY</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">DATASET_SIZE_TRAIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60000</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">DATASET_SIZE_VAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">NUM_BATCHES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DATASET_SIZE_TRAIN</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">BATCH_SIZE</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>As in the previous examples we assemble the hyperparameters of the model into a stateless, compile-time specification struct and define the optimizer and model types:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">STRUCTURE_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">StructureSpecification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">NUM_LAYERS</span><span class="p">,</span><span class="w"> </span><span class="n">HIDDEN_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">ACTIVATION_FUNCTION</span><span class="p">,</span><span class="w"> </span><span class="n">ACTIVATION_FUNCTION_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">OPTIMIZER_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">optimizers</span><span class="o">::</span><span class="n">adam</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">OPTIMIZER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">optimizers</span><span class="o">::</span><span class="n">Adam</span><span class="o">&lt;</span><span class="n">OPTIMIZER_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">NETWORK_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">AdamSpecification</span><span class="o">&lt;</span><span class="n">STRUCTURE_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">MODEL_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">NeuralNetworkAdam</span><span class="o">&lt;</span><span class="n">NETWORK_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Furthermore, we declare the device, random number generator optimizer and model as well as buffers. The buffers are created with a batch size of <span class="math notranslate nohighlight">\(1\)</span> because for clarity we iteratively accumulate the gradient for each batch sample by sample in the training loop that is following later. Additionally, we declare and allocate containers for the training and validation data and buffer matrices for the training process:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">DEVICE</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<span class="n">TI</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">default_engine</span><span class="p">(</span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">::</span><span class="n">RANDOM</span><span class="p">(),</span><span class="w"> </span><span class="n">seed</span><span class="p">);</span>
<span class="n">OPTIMIZER</span><span class="w"> </span><span class="n">optimizer</span><span class="p">;</span>
<span class="n">MODEL_TYPE</span><span class="w"> </span><span class="n">model</span><span class="p">;</span>
<span class="k">typename</span><span class="w"> </span><span class="nc">MODEL_TYPE</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffers</span><span class="p">;</span>

<span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">DATASET_SIZE_TRAIN</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_DIM</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">x_train</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">DATASET_SIZE_VAL</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_DIM</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">x_val</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">DATASET_SIZE_TRAIN</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">y_train</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">DATASET_SIZE_VAL</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">y_val</span><span class="p">;</span>

<span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">layouts</span><span class="o">::</span><span class="n">RowMajorAlignment</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">d_loss_d_output_matrix</span><span class="p">;</span>

<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">x_train</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">y_train</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">x_val</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">y_val</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">d_loss_d_output_matrix</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>We use the freshly allocated containers for the dataset to load the MNIST images from the <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">dataset_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/data/mnist.hdf5&quot;</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">data_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HighFive</span><span class="o">::</span><span class="n">File</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span><span class="w"> </span><span class="n">HighFive</span><span class="o">::</span><span class="n">File</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">x_train</span><span class="p">,</span><span class="w"> </span><span class="n">data_file</span><span class="p">.</span><span class="n">getGroup</span><span class="p">(</span><span class="s">&quot;train&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;inputs&quot;</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">y_train</span><span class="p">,</span><span class="w"> </span><span class="n">data_file</span><span class="p">.</span><span class="n">getGroup</span><span class="p">(</span><span class="s">&quot;train&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;labels&quot;</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">x_val</span><span class="p">,</span><span class="w"> </span><span class="n">data_file</span><span class="p">.</span><span class="n">getGroup</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;inputs&quot;</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">y_val</span><span class="p">,</span><span class="w"> </span><span class="n">data_file</span><span class="p">.</span><span class="n">getGroup</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;labels&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Like in the previous tutorial we reset the optimizer state (first and second order moments of the gradient) because they can contain arbitrary data after allocation and randomly initialize the weights of the model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">rlt</span><span class="o">::</span><span class="n">reset_optimizer_state</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">init_weights</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>The following cell contains the full training loop for a single epoch (which is usually enough to classify the handwritten MNIST digits with a high accuracy). First, the gradient is set to zero, then for each sample we take a view (zero-copy) into the dataset to get the input and (one-hot encoded) output. We run the forward pass and use a categorical cross entropy loss to judge the similarity of the output distribution (logits that correspond to a softmax over the digits 0-9) and the empirical
distribution (one-hot) taken from the ground-truth label. For the training we are only interested in the <code class="docutils literal notranslate"><span class="pre">::gradient</span></code> of this loss but for monitoring the training process we additionally calculate the actual loss value as well. Using the gradient of the loss function (pushing up the logit of the correct digit and pushing down the logits of the wrong digits) we invoke the backpropagation algorithm to calculate and accumulate the gradient of the loss of this example wrt to all parameters in the
model.</p>
<p>Once we finished the loss calculation and gradient accumulation for all samples in the batch we can invoke the optimizer using the <code class="docutils literal notranslate"><span class="pre">rlt::step</span></code> operator. In this update step the previously selected optimizer Adam calculates its required statistics (first and second order moment of the gradient of each parameter in the model) and updates the parameters based on it. We iterate through all (full) batches available in the dataset (making up one epoch):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">batch_i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">batch_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_BATCHES</span><span class="p">;</span><span class="w"> </span><span class="n">batch_i</span><span class="o">++</span><span class="p">){</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">rlt</span><span class="o">::</span><span class="n">zero_gradient</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sample_i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">sample_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BATCH_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">sample_i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">row</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">x_train</span><span class="p">,</span><span class="w"> </span><span class="n">batch_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BATCH_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sample_i</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">row</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">y_train</span><span class="p">,</span><span class="w"> </span><span class="n">batch_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BATCH_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sample_i</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">row</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">output_layer</span><span class="p">.</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">rlt</span><span class="o">::</span><span class="n">forward</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>
<span class="w">        </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">loss_functions</span><span class="o">::</span><span class="n">categorical_cross_entropy</span><span class="o">::</span><span class="n">gradient</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">prediction</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">d_loss_d_output_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">T</span><span class="p">)</span><span class="n">BATCH_SIZE</span><span class="p">));</span>
<span class="w">        </span><span class="n">loss</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">loss_functions</span><span class="o">::</span><span class="n">categorical_cross_entropy</span><span class="o">::</span><span class="n">evaluate</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">prediction</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">T</span><span class="p">)</span><span class="n">BATCH_SIZE</span><span class="p">));</span>
<span class="w">        </span><span class="n">rlt</span><span class="o">::</span><span class="n">backward</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">d_loss_d_output_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">buffers</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">loss</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">BATCH_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">rlt</span><span class="o">::</span><span class="n">step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">batch_i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;batch: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">batch_i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">NUM_BATCHES</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; loss: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">loss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
batch: 0/1875 loss: 0.280092
batch: 100/1875 loss: 0.0254528
batch: 200/1875 loss: 0.0289113
batch: 300/1875 loss: 0.00838864
batch: 400/1875 loss: 0.00909101
batch: 500/1875 loss: 0.0176317
batch: 600/1875 loss: 0.0102458
batch: 700/1875 loss: 0.00427032
batch: 800/1875 loss: 0.00866193
batch: 900/1875 loss: 0.00429899
batch: 1000/1875 loss: 0.0209082
batch: 1100/1875 loss: 0.00755304
batch: 1200/1875 loss: 0.00581567
batch: 1300/1875 loss: 0.00471603
batch: 1400/1875 loss: 0.00802572
batch: 1500/1875 loss: 0.00992347
batch: 1600/1875 loss: 0.0063443
batch: 1700/1875 loss: 0.00276589
batch: 1800/1875 loss: 0.00870133
</pre></div></div>
</div>
<p>In the following we validate the trained model on a held-out validation dataset and print some examples of classified handwritten digits. Finally we print the classification accuracy on the valiation set which should be above <span class="math notranslate nohighlight">\(90\%\)</span> in our experience which is quite surprising given that we only use a simple, full-connected neural network as the model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="w"> </span><span class="n">val_loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">T</span><span class="w"> </span><span class="n">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sample_i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">sample_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DATASET_SIZE_VAL</span><span class="p">;</span><span class="w"> </span><span class="n">sample_i</span><span class="o">++</span><span class="p">){</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">row</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">x_val</span><span class="p">,</span><span class="w"> </span><span class="n">sample_i</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">row</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">y_val</span><span class="p">,</span><span class="w"> </span><span class="n">sample_i</span><span class="p">);</span>
<span class="w">    </span><span class="n">rlt</span><span class="o">::</span><span class="n">forward</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>
<span class="w">    </span><span class="n">val_loss</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">loss_functions</span><span class="o">::</span><span class="n">categorical_cross_entropy</span><span class="o">::</span><span class="n">evaluate</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">output_layer</span><span class="p">.</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">BATCH_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">TI</span><span class="w"> </span><span class="n">predicted_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">argmax_row</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">output_layer</span><span class="p">.</span><span class="n">output</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">sample_i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">TI</span><span class="w"> </span><span class="n">row_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">28</span><span class="p">;</span><span class="w"> </span><span class="n">row_i</span><span class="o">++</span><span class="p">){</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">TI</span><span class="w"> </span><span class="n">col_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">28</span><span class="p">;</span><span class="w"> </span><span class="n">col_i</span><span class="o">++</span><span class="p">){</span>
<span class="w">                </span><span class="n">T</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">row_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col_i</span><span class="p">);</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">predicted_label</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">accuracy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">predicted_label</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">val_loss</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">DATASET_SIZE_VAL</span><span class="p">;</span>
<span class="n">accuracy</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">DATASET_SIZE_VAL</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Validation accuracy: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">accuracy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;%&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>







             7 7 7 7 7 7
             7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
             7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
                       7 7 7 7 7 7 7 7 7 7 7
                                     7 7 7 7
                                   7 7 7 7
                                   7 7 7 7
                                 7 7 7 7
                                 7 7 7 7
                               7 7 7 7
                               7 7 7
                             7 7 7 7
                           7 7 7 7
                         7 7 7 7 7
                         7 7 7 7
                       7 7 7 7 7
                       7 7 7 7
                     7 7 7 7 7
                     7 7 7 7 7
                     7 7 7 7








                           9 9 9 9 9 9
                           9 9 9 9 9 9 9
                         9 9 9 9 9 9 9 9
                         9 9 9 9 9 9 9 9
                       9 9 9   9 9 9 9 9
                       9 9 9 9 9 9 9 9 9
                       9 9 9 9 9 9 9 9 9
                       9 9 9 9 9 9 9 9 9
                         9 9 9 9 9 9 9 9
                             9 9 9 9 9
                             9 9 9 9 9
                           9 9 9 9 9
                         9 9 9 9 9
                         9 9 9 9
                       9 9 9 9 9
                   9 9 9 9 9
                   9 9 9 9
                 9 9 9 9 9
                 9 9 9 9
                 9 9 9



                                   6 6
                               6 6 6 6
                             6 6 6 6 6
                             6 6 6 6
                         6 6 6 6 6
                         6 6 6
                         6 6 6
                       6 6 6 6
                     6 6 6 6
                     6 6 6
                   6 6 6         6 6 6
                     6 6 6   6 6 6 6 6 6 6
                     6 6 6 6 6 6 6 6 6 6 6
                   6 6 6 6 6 6 6 6 6 6 6 6
                     6 6 6 6 6         6 6
                   6 6 6 6 6         6 6 6
                   6 6 6 6 6     6 6 6 6
                   6 6 6 6 6 6 6 6 6 6
                   6 6 6 6 6 6 6 6 6 6
                           6 6 6 6 6









                             6 6 6 6
                           6 6 6 6 6
                           6 6 6 6 6
                         6 6 6 6
                         6 6 6
                       6 6 6
                       6 6 6
                       6 6
                     6 6 6
                     6 6 6
                     6 6 6 6 6 6 6
                     6 6 6 6 6 6 6 6 6 6
                     6 6 6 6 6 6 6 6 6 6 6
                     6 6 6       6 6 6 6 6
                     6 6 6 6         6 6 6 6
                     6 6 6             6 6 6
                       6 6 6           6 6 6
                       6 6 6 6       6 6 6
                       6 6 6 6 6 6 6 6 6 6
                         6 6 6 6 6 6 6










                   4 4 4 4 4 4 4 4
                 4 4 4 4 4 4 4 4 4
               4 4 4 4 4     4 4 4 4
             4 4 4 4           4 4 4
             4 4 4               4 4 4
             4 4 4               4 4 4
             4 4 4                 4 4
             4 4 4                 4 4 4 4
             4 4 4 4 4 4 4     4 4 4 4 4 4
             4 4 4 4 4 4 4 4 4 4 4 4 4 4
               4 4 4 4 4 4 4 4 4 4 4 4 4
                   4 4 4 4 4 4 4 4 4 4 4
                                 4 4 4 4 4
                                   4 4 4 4
                                   4 4 4 4 4
                                   4 4 4 4 4 4
                                     4 4 4 4 4 4
                                     4 4 4 4 4 4
                                     4 4 4 4 4
                                     4 4 4 4








                 3 3 3 3 3 3 3 3 3
               3 3 3 3 3 3 3 3 3 3 3
               3 3 3 3 3 3     3 3 3 3
               3 3 3         3 3 3 3
                           3 3 3 3 3
                         3 3 3 3 3
                       3 3 3 3 3
                   3 3 3 3 3 3
               3 3 3 3 3 3 3 3
             3 3 3 3 3 3 3 3 3 3 3 3
             3 3 3 3 3 3   3 3 3 3 3 3 3
             3 3                 3 3 3 3 3
                                   3 3 3 3
                                     3 3 3 3
                                     3 3 3 3
                                     3 3 3 3
                 3 3             3 3 3 3 3 3
                 3 3 3 3 3 3 3 3 3 3 3 3 3
                   3 3 3 3 3 3 3 3 3 3 3
                     3 3 3 3 3 3 3











                   9 9 9 9 9 9 9 9 9 9
                 9 9 9 9 9 9 9 9 9 9 9
                 9 9 9 9 9 9 9 9 9 9 9 9
                 9 9 9 9 9 9 9 9 9 9 9 9
                 9 9 9         9 9 9 9 9
                 9 9 9 9 9 9   9 9 9 9 9
                 9 9 9 9 9 9 9 9 9 9 9 9
                 9 9 9 9 9 9 9 9 9 9 9
                     9 9 9 9 9 9 9 9 9
                                 9 9 9
                                 9 9 9
                                 9 9 9
                                 9 9 9
                                 9 9 9
                                 9 9 9
                                 9 9 9 9
                                 9 9 9 9
                                 9 9 9 9
                                 9 9 9 9
                                   9 9 9




                                 1 1 1
                                 1 1 1
                               1 1 1 1
                               1 1 1
                               1 1 1
                             1 1 1 1
                             1 1 1
                             1 1 1
                           1 1 1 1
                           1 1 1
                           1 1 1
                         1 1 1 1
                         1 1 1
                         1 1 1
                       1 1 1 1
                     1 1 1 1
                   1 1 1 1 1
                   1 1 1 1 1
                   1 1 1 1
                   1 1 1







                                         4 4 4
                                         4 4 4 4
                                       4 4 4 4 4
                                     4 4 4 4 4 4
                                     4 4 4 4 4 4
                                   4 4 4 4 4 4 4
                   4 4             4 4 4 4 4 4
                 4 4 4 4 4       4 4 4 4 4 4 4
             4 4 4 4 4 4 4       4 4 4 4 4 4
           4 4 4 4 4 4 4 4       4 4 4 4 4 4
           4 4 4 4 4 4 4 4       4 4 4 4 4
         4 4 4 4 4 4 4 4       4 4 4 4 4 4
         4 4 4 4 4 4 4       4 4 4 4 4 4 4
         4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
         4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
         4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
         4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
           4 4 4 4 4 4 4 4 4 4 4 4 4 4 4   4














                   7 7 7 7 7 7
                 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
               7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
               7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
             7 7 7 7 7       7 7 7 7 7 7 7 7 7 7 7
             7 7 7 7               7 7 7 7 7 7
               7 7               7 7 7 7 7 7
                               7 7 7 7 7
                               7 7 7 7 7
                             7 7 7 7 7
                             7 7 7 7
                           7 7 7 7
                       7 7 7 7 7
                       7 7 7 7 7
                   7 7 7 7 7 7
                 7 7 7 7 7 7
               7 7 7 7 7 7
             7 7 7 7 7 7
             7 7 7 7 7
             7 7 7 7 7

Validation accuracy: 93%
</pre></div></div>
</div>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="06-Deep%20Reinforcement%20Learning.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Deep Reinforcement Learning</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="04-CPU%20Acceleration.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">CPU Acceleration</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>