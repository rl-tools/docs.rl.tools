<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="The Loop Interface" href="07-The%20Loop%20Interface.html" /><link rel="prev" title="MNIST Classification" href="05-MNIST%20Classification.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>Deep Reinforcement Learning - RLtools Documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="_static/overrides.css?v=ca018f06" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #639694;
  --color-brand-content: #639694;
  --color-admonition-background: orange;
  --sidebar_hide_name: True;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">RLtools Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/banner.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">RLtools Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="01-Containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-Multiple%20Dispatch.html">Multiple Dispatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-Deep%20Learning.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-CPU%20Acceleration.html">CPU Acceleration</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-MNIST%20Classification.html">MNIST Classification</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Deep Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-The%20Loop%20Interface.html">The Loop Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="08-Custom%20Environment.html">Custom Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="09-TinyRL.html">TinyRL: A Python Interface for RLtools</a></li>
<li class="toctree-l1"><a class="reference internal" href="10-Experiment%20Tracking.html">Experiment Tracking</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="Deep-Reinforcement-Learning">
<h1>Deep Reinforcement Learning<a class="headerlink" href="#Deep-Reinforcement-Learning" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://mybinder.org/v2/gh/rl-tools/documentation/binder?labpath=06-Deep%20Reinforcement%20Learning.ipynb"><img alt="Binder" src="https://mybinder.org/badge_logo.svg" /></a></p>
<p>In this chapter we use the previously demonstrated deep learning capabilities of <strong>RLtools</strong> in combination with a (inverted) pendulum simulator that is equivalent to the <code class="docutils literal notranslate"><span class="pre">Pendulum-v1</span></code> in <a class="reference external" href="https://github.com/Farama-Foundation/Gymnasium">gym/gymnasium</a> to train a swing-up control policy. For the training, we use the <a class="reference external" href="https://proceedings.mlr.press/v80/fujimoto18a">TD3</a> off-policy, deep-RL algorithm. TD3 and required supporting data structures and algorithms are integrated in <strong>RLtools</strong>.</p>
<div align="center"><p><img alt="animated" class="no-scaled-link" src="_images/pendulum_v1_inference.gif" style="height: 200px;" /></p>
</div><p>Note that the training time in the animation refers to bare metal training, not using the Cling interpreter like these notebooks do. As you can see from the training later on even when dispatching to a BLAS library, Cling is much slower than optimized, bare-metal code. See the repository <a class="reference external" href="https://github.com/rl-tools/rl-tools">https://github.com/rl-tools/rl-tools</a> for more information on how to run the training directly on your hardware. You can also try the <a class="reference external" href="https://en.wikipedia.org/wiki/WebAssembly">WASM</a> based training in your
browser at <a class="reference external" href="https://rl.tools">https://rl.tools</a>.</p>
<p>First, as beforehand we include the necessary primitive operations (dispatching matrix multiplications to OpenBLAS). We also use the neural network operations (dense layer forward and backward pass) that take advantage of OpenBLAS through <code class="docutils literal notranslate"><span class="pre">the</span> <span class="pre">nn/operations_cpu_mux.h</span></code> multiplexer. The accelerated forward and backward pass are automatically used if the higher level operations (forward/backward pass on the full model) are called with the OpenBLAS device (coming from the <code class="docutils literal notranslate"><span class="pre">DEVICE_FACTORY</span></code>). To
make the accelerated routines available to the higher-level functions, <code class="docutils literal notranslate"><span class="pre">nn_models/operations_cpu.h</span></code> has to be included after <code class="docutils literal notranslate"><span class="pre">nn/operations_cpu_mux.h</span></code>.</p>
<p>The pendulum environment is implemented in pure C++ without dependencies, hence it contains only generic operations and can be included by the collective <code class="docutils literal notranslate"><span class="pre">rl/environments/operations_generic.h</span></code> that includes all generic functions of all available environments.</p>
<p>For TD3 and all its related data structures and algorithms we just need to include <code class="docutils literal notranslate"><span class="pre">rl/operations_generic.h</span></code> because all the operations are higher-level and dispatch to the lower-level primitives imported beforehand. The RL operations call functions to interact with the environment as well as perform forward and backward passes on the neural network model which in turn calls the dense layer operations.</p>
<p>We also include the Xeus UI for the pendulum (to be rendered in the notebook when it is run live). Furthermore, we include <code class="docutils literal notranslate"><span class="pre">rl/utils/evaluation.h</span></code> so that we can easily execute deterministic rollouts (without exploration noise) and get average rewards in fixed intervals to monitor the training progress. The evaluation function can also take the UI as an input and render a live animation of the pendulum.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define RL_TOOLS_BACKEND_ENABLE_OPENBLAS</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/operations/cpu_mux.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/nn/operations_cpu_mux.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/rl/environments/pendulum/operations_generic.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/nn_models/operations_cpu.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/rl/algorithms/td3/operations_generic.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/rl/components/off_policy_runner/operations_generic.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/rl/environments/pendulum/ui_xeus.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rl_tools/rl/utils/evaluation/operations_generic.h&gt;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">rlt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">rl_tools</span><span class="p">;</span>
<span class="cp">#pragma cling load(&quot;openblas&quot;)</span>
</pre></div>
</div>
</div>
<p>We set up the major types like before again. <code class="docutils literal notranslate"><span class="pre">float</span></code> is usually much faster while still being sufficient for deep and reinforcement learning. You can try switching to <code class="docutils literal notranslate"><span class="pre">double</span></code> and re-run the notebook to see the difference in training time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">DEVICE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">devices</span><span class="o">::</span><span class="n">DEVICE_FACTORY</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">devices</span><span class="o">::</span><span class="n">DefaultCPUSpecification</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Next, we define the <code class="docutils literal notranslate"><span class="pre">ENVIRONMENT</span></code> type which acts as a compile-time interface between simulations and RL algorithms. In <strong>RLtools</strong> environments share a common interface that is similar to the <code class="docutils literal notranslate"><span class="pre">gym/gymnasium</span></code> interface but e.g. has the observation and state dimensionality as compile-time constants so that the compiler can maximally optimize each part of the code. The RL algorithms and the following training procedure are agnostic to the type of environment used as long as exposes the
required interface.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">ENVIRONMENT_PARAMETERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">environments</span><span class="o">::</span><span class="n">pendulum</span><span class="o">::</span><span class="n">DefaultParameters</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">ENVIRONMENT_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">environments</span><span class="o">::</span><span class="n">pendulum</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT_PARAMETERS</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">environments</span><span class="o">::</span><span class="n">Pendulum</span><span class="o">&lt;</span><span class="n">ENVIRONMENT_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Next we define some hyperparameters to train the pendulum swing-up. Note the very low <code class="docutils literal notranslate"><span class="pre">STEP_LIMIT</span></code> which is tribute to <code class="docutils literal notranslate"><span class="pre">TD3</span></code> being relatively sample efficient (e.g. in comparison to <a class="reference external" href="https://arxiv.org/abs/1707.06347">PPO</a>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">TD3_PENDULUM_PARAMETERS</span><span class="o">:</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">algorithms</span><span class="o">::</span><span class="n">td3</span><span class="o">::</span><span class="n">DefaultParameters</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="o">&gt;</span><span class="p">{</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="w"> </span><span class="n">CRITIC_BATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="w"> </span><span class="n">ACTOR_BATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">STEP_LIMIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">REPLAY_BUFFER_CAP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STEP_LIMIT</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N_WARMUP_STEPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TD3_PENDULUM_PARAMETERS</span><span class="o">::</span><span class="n">ACTOR_BATCH_SIZE</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">EPISODE_STEP_LIMIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">ACTOR_NUM_LAYERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">ACTOR_HIDDEN_DIM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">CRITIC_NUM_LAYERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="n">CRITIC_HIDDEN_DIM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">ACTOR_ACTIVATION_FUNCTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">activation_functions</span><span class="o">::</span><span class="n">RELU</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">CRITIC_ACTIVATION_FUNCTION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">activation_functions</span><span class="o">::</span><span class="n">RELU</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">ACTOR_ACTIVATION_FUNCTION_OUTPUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">activation_functions</span><span class="o">::</span><span class="n">TANH</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">CRITIC_ACTIVATION_FUNCTION_OUTPUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">activation_functions</span><span class="o">::</span><span class="n">IDENTITY</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">TD3_PARAMETERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TD3_PENDULUM_PARAMETERS</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>In the following these hyperparameters are used to set up the actor and critic types and combine them into a combined actor-critic type that is used in the TD3 implementation. Furthermore, we are defining an off-policy runner type that contains a replay buffer and interacts with the environment. Initially, we were hiding this complexity in the actor critic structure but we found that exposing it is beneficial because the user has more agency and can swap out parts more easily. For example the
actor and critic network types can be any type for which a <code class="docutils literal notranslate"><span class="pre">rlt::forward</span></code> and <code class="docutils literal notranslate"><span class="pre">rlt::backward</span></code> operation exist (these functions should be included before the RL operations like described above).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">ACTOR_STRUCTURE_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">StructureSpecification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="o">::</span><span class="n">OBSERVATION_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="o">::</span><span class="n">ACTION_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">ACTOR_NUM_LAYERS</span><span class="p">,</span><span class="w"> </span><span class="n">ACTOR_HIDDEN_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">ACTOR_ACTIVATION_FUNCTION</span><span class="p">,</span><span class="w"> </span><span class="n">ACTOR_ACTIVATION_FUNCTION_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="n">TD3_PARAMETERS</span><span class="o">::</span><span class="n">ACTOR_BATCH_SIZE</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">CRITIC_STRUCTURE_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">StructureSpecification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="o">::</span><span class="n">OBSERVATION_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="o">::</span><span class="n">ACTION_DIM</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CRITIC_NUM_LAYERS</span><span class="p">,</span><span class="w"> </span><span class="n">CRITIC_HIDDEN_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">CRITIC_ACTIVATION_FUNCTION</span><span class="p">,</span><span class="w"> </span><span class="n">CRITIC_ACTIVATION_FUNCTION_OUTPUT</span><span class="p">,</span><span class="w"> </span><span class="n">TD3_PARAMETERS</span><span class="o">::</span><span class="n">CRITIC_BATCH_SIZE</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">OPTIMIZER_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">optimizers</span><span class="o">::</span><span class="n">adam</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">OPTIMIZER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn</span><span class="o">::</span><span class="n">optimizers</span><span class="o">::</span><span class="n">Adam</span><span class="o">&lt;</span><span class="n">OPTIMIZER_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">ACTOR_NETWORK_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">AdamSpecification</span><span class="o">&lt;</span><span class="n">ACTOR_STRUCTURE_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">ACTOR_NETWORK_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">NeuralNetworkAdam</span><span class="o">&lt;</span><span class="n">ACTOR_NETWORK_SPEC</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">ACTOR_TARGET_NETWORK_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">InferenceSpecification</span><span class="o">&lt;</span><span class="n">ACTOR_STRUCTURE_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">ACTOR_TARGET_NETWORK_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl_tools</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">NeuralNetwork</span><span class="o">&lt;</span><span class="n">ACTOR_TARGET_NETWORK_SPEC</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">CRITIC_NETWORK_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">AdamSpecification</span><span class="o">&lt;</span><span class="n">CRITIC_STRUCTURE_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">CRITIC_NETWORK_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl_tools</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">NeuralNetworkAdam</span><span class="o">&lt;</span><span class="n">CRITIC_NETWORK_SPEC</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">CRITIC_TARGET_NETWORK_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl_tools</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">InferenceSpecification</span><span class="o">&lt;</span><span class="n">CRITIC_STRUCTURE_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">CRITIC_TARGET_NETWORK_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl_tools</span><span class="o">::</span><span class="n">nn_models</span><span class="o">::</span><span class="n">mlp</span><span class="o">::</span><span class="n">NeuralNetwork</span><span class="o">&lt;</span><span class="n">CRITIC_TARGET_NETWORK_SPEC</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">TD3_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">algorithms</span><span class="o">::</span><span class="n">td3</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE</span><span class="o">::</span><span class="n">index_t</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="p">,</span><span class="w"> </span><span class="n">ACTOR_NETWORK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">ACTOR_TARGET_NETWORK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">CRITIC_NETWORK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">CRITIC_TARGET_NETWORK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">OPTIMIZER</span><span class="p">,</span><span class="w"> </span><span class="n">TD3_PARAMETERS</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">ACTOR_CRITIC_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">algorithms</span><span class="o">::</span><span class="n">td3</span><span class="o">::</span><span class="n">ActorCritic</span><span class="o">&lt;</span><span class="n">TD3_SPEC</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">OFF_POLICY_RUNNER_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">components</span><span class="o">::</span><span class="n">off_policy_runner</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span>
<span class="w">    </span><span class="n">T</span><span class="p">,</span>
<span class="w">    </span><span class="n">TI</span><span class="p">,</span>
<span class="w">    </span><span class="n">ENVIRONMENT</span><span class="p">,</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">REPLAY_BUFFER_CAP</span><span class="p">,</span>
<span class="w">    </span><span class="n">EPISODE_STEP_LIMIT</span>
<span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">OFF_POLICY_RUNNER_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">components</span><span class="o">::</span><span class="n">OffPolicyRunner</span><span class="o">&lt;</span><span class="n">OFF_POLICY_RUNNER_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>In this tutorial we assume the actor and critic batch sizes are equal:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">static_assert</span><span class="p">(</span><span class="n">ACTOR_CRITIC_TYPE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">::</span><span class="n">PARAMETERS</span><span class="o">::</span><span class="n">ACTOR_BATCH_SIZE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTOR_CRITIC_TYPE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">::</span><span class="n">PARAMETERS</span><span class="o">::</span><span class="n">CRITIC_BATCH_SIZE</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Next we instantiate the elementary data structures:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">DEVICE</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<span class="n">OPTIMIZER</span><span class="w"> </span><span class="n">optimizer</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">default_engine</span><span class="p">(</span><span class="k">typename</span><span class="w"> </span><span class="nc">DEVICE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">::</span><span class="n">RANDOM</span><span class="p">{},</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">environments</span><span class="o">::</span><span class="n">DummyUI</span><span class="w"> </span><span class="n">ui</span><span class="p">;</span><span class="w"> </span><span class="c1">// this is used later to signal the rlt::evaluate to not use a UI</span>
</pre></div>
</div>
</div>
<p>Next we declare and initialize the actor critic structure (containing the actors and critics). The <code class="docutils literal notranslate"><span class="pre">rlt::init</span></code> recursively initializes all submodules (e.g. the MLP using the Kaiming initialization):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">ACTOR_CRITIC_TYPE</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Furthermore the off-policy runner is instantiated and initialized with a single environment. Note that the off-policy runner contains the replay buffer which is allocated recursively with the <code class="docutils literal notranslate"><span class="pre">rlt::malloc</span></code> call.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">OFF_POLICY_RUNNER_TYPE</span><span class="w"> </span><span class="n">off_policy_runner</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">off_policy_runner</span><span class="p">);</span>
<span class="n">ENVIRONMENT</span><span class="w"> </span><span class="n">envs</span><span class="p">[</span><span class="k">decltype</span><span class="p">(</span><span class="n">off_policy_runner</span><span class="p">)</span><span class="o">::</span><span class="n">N_ENVIRONMENTS</span><span class="p">];</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">off_policy_runner</span><span class="p">,</span><span class="w"> </span><span class="n">envs</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>We like to avoid memory allocations during the training, hence we pre-allocate batch containers for the actor and critic as well as two buffers for each. The <code class="docutils literal notranslate"><span class="pre">*_training_buffers</span></code> contain pre-allocated containers used during the training step in the TD3 algorithm. The <code class="docutils literal notranslate"><span class="pre">*_buffers</span></code> are used to hold intermediate results during the forward and backward pass of the MLP.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">OFF_POLICY_RUNNER_TYPE</span><span class="o">::</span><span class="n">Batch</span><span class="o">&lt;</span><span class="n">TD3_PARAMETERS</span><span class="o">::</span><span class="n">CRITIC_BATCH_SIZE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">critic_batch</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">algorithms</span><span class="o">::</span><span class="n">td3</span><span class="o">::</span><span class="n">CriticTrainingBuffers</span><span class="o">&lt;</span><span class="n">ACTOR_CRITIC_TYPE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">&gt;</span><span class="w"> </span><span class="n">critic_training_buffers</span><span class="p">;</span>
<span class="n">CRITIC_NETWORK_TYPE</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&lt;</span><span class="n">ACTOR_CRITIC_TYPE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">::</span><span class="n">PARAMETERS</span><span class="o">::</span><span class="n">CRITIC_BATCH_SIZE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">critic_buffer</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">critic_batch</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">critic_training_buffers</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">critic_buffer</span><span class="p">);</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">OFF_POLICY_RUNNER_TYPE</span><span class="o">::</span><span class="n">Batch</span><span class="o">&lt;</span><span class="n">TD3_PARAMETERS</span><span class="o">::</span><span class="n">ACTOR_BATCH_SIZE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actor_batch</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">algorithms</span><span class="o">::</span><span class="n">td3</span><span class="o">::</span><span class="n">ActorTrainingBuffers</span><span class="o">&lt;</span><span class="n">ACTOR_CRITIC_TYPE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actor_training_buffers</span><span class="p">;</span>
<span class="n">ACTOR_NETWORK_TYPE</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&lt;</span><span class="n">ACTOR_CRITIC_TYPE</span><span class="o">::</span><span class="n">SPEC</span><span class="o">::</span><span class="n">PARAMETERS</span><span class="o">::</span><span class="n">ACTOR_BATCH_SIZE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actor_buffer</span><span class="p">;</span>
<span class="n">ACTOR_NETWORK_TYPE</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&lt;</span><span class="n">OFF_POLICY_RUNNER_SPEC</span><span class="o">::</span><span class="n">N_ENVIRONMENTS</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actor_buffer_eval</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_batch</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_training_buffers</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer_eval</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>For the pendulum training we don’t use observation normalization but the <code class="docutils literal notranslate"><span class="pre">rlt::evaluate</span></code> function expects mean and standard deviation so we initialize them to an isotropic, standard normal distribution:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="o">::</span><span class="n">OBSERVATION_DIM</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">observations_mean</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">MatrixDynamic</span><span class="o">&lt;</span><span class="n">rlt</span><span class="o">::</span><span class="n">matrix</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ENVIRONMENT</span><span class="o">::</span><span class="n">OBSERVATION_DIM</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">observations_std</span><span class="p">;</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">observations_mean</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">observations_std</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">set_all</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">observations_mean</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">rlt</span><span class="o">::</span><span class="n">set_all</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">observations_std</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Now we can finally train the pendulum swing up. We iterate over <code class="docutils literal notranslate"><span class="pre">STEP_LIMIT</span></code> steps. Every <code class="docutils literal notranslate"><span class="pre">1000</span></code> steps we evaluate the averate return of the current policy (using deterministic rollouts without exploration noise). On every iteration we call <code class="docutils literal notranslate"><span class="pre">rlt::step</span></code> which uses the off-policy runner to execute one step using the current policy and save it in its internal replay buffer. After some warmup steps we can start training the actor and critic models. To train the critic, we sample target action
noise (such that the training itself is deterministic), sample a batch from the replay buffer and train the critic. This is done for each critic individually. On every other step we use the current target critic to train the actor using another batch sampled from the replay buffer. We also update the target critics and actor on every other step. For more details on the TD3 training procedure you can look into the called functions and refer to the <a class="reference external" href="https://proceedings.mlr.press/v80/fujimoto18a">TD3
paper</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">step_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">step_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">STEP_LIMIT</span><span class="p">;</span><span class="w"> </span><span class="n">step_i</span><span class="o">+=</span><span class="n">OFF_POLICY_RUNNER_SPEC</span><span class="o">::</span><span class="n">N_ENVIRONMENTS</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// Taking the training time and evaluating the agent</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">step_i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">step_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STEP_LIMIT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">elapsed_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">;</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">evaluate</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">envs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ui</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">.</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">utils</span><span class="o">::</span><span class="n">evaluation</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">EPISODE_STEP_LIMIT</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">observations_mean</span><span class="p">,</span><span class="w"> </span><span class="n">observations_std</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer_eval</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Step: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">step_i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">STEP_LIMIT</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; mean return: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">returns_mean</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">elapsed_seconds</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;s)&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// One environment step (saved in the replay buffer)</span>
<span class="w">    </span><span class="n">rlt</span><span class="o">::</span><span class="n">step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">off_policy_runner</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">.</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer_eval</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// TD3 training using the replay buffer</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">step_i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">N_WARMUP_STEPS</span><span class="p">){</span>
<span class="w">        </span><span class="c1">// Critic training</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">critic_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">critic_i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">critic_i</span><span class="o">++</span><span class="p">){</span>
<span class="w">            </span><span class="n">rlt</span><span class="o">::</span><span class="n">target_action_noise</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">,</span><span class="w"> </span><span class="n">critic_training_buffers</span><span class="p">.</span><span class="n">target_next_action_noise</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
<span class="w">            </span><span class="n">rlt</span><span class="o">::</span><span class="n">gather_batch</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">off_policy_runner</span><span class="p">,</span><span class="w"> </span><span class="n">critic_batch</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
<span class="w">            </span><span class="n">rlt</span><span class="o">::</span><span class="n">train_critic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">,</span><span class="w"> </span><span class="n">critic_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">.</span><span class="n">critic_1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">.</span><span class="n">critic_2</span><span class="p">,</span><span class="w"> </span><span class="n">critic_batch</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">critic_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">critic_training_buffers</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Actor training</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">step_i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">rlt</span><span class="o">::</span><span class="n">gather_batch</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">off_policy_runner</span><span class="p">,</span><span class="w"> </span><span class="n">actor_batch</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
<span class="w">                </span><span class="n">rlt</span><span class="o">::</span><span class="n">train_actor</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">,</span><span class="w"> </span><span class="n">actor_batch</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">critic_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">actor_training_buffers</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">rlt</span><span class="o">::</span><span class="n">update_critic_targets</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">);</span>
<span class="w">            </span><span class="n">rlt</span><span class="o">::</span><span class="n">update_actor_target</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Step: 0/9999 mean return: -1525.26 (4.3054e-05s)
Step: 1000/9999 mean return: -1432.64 (11.5122s)
Step: 2000/9999 mean return: -1383.43 (25.3272s)
Step: 3000/9999 mean return: -1110.79 (61.9017s)
Step: 4000/9999 mean return: -445.918 (93.1101s)
Step: 5000/9999 mean return: -825.857 (121.833s)
Step: 6000/9999 mean return: -665.284 (152.726s)
Step: 7000/9999 mean return: -549.657 (176.19s)
Step: 8000/9999 mean return: -290.78 (197.574s)
Step: 9000/9999 mean return: -163.102 (218.141s)
Step: 9999/9999 mean return: -156.811 (238.915s)
</pre></div></div>
</div>
<p>In the case of the pendulum a mean return of around <code class="docutils literal notranslate"><span class="pre">-200</span></code> means that the policy learned to swing it up from any initial condition and stabilize it in the upright position.</p>
<p>Note: If the same Pendulum training is run natively (not using the C++ interpreter used in this notebook) the training only takes a couple of seconds. Hence we encourage you to follow the steps in the <a class="reference external" href="https://github.com/rl-tools/rl-tools">README</a> to run RLtools natively after playing with the following bonus ;)</p>
<p><strong>Bonus</strong> (this only works when you are running this tutorial live because this draws to a temporary canvas)</p>
<p>We implemented a UI (<code class="docutils literal notranslate"><span class="pre">pendulum::ui::Xeus</span></code>) that can render to a canvas element in this notebook:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">UI_SPEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">environments</span><span class="o">::</span><span class="n">pendulum</span><span class="o">::</span><span class="n">ui</span><span class="o">::</span><span class="n">xeus</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// float type, index type, size, playback speed (in %)</span>
<span class="k">using</span><span class="w"> </span><span class="n">UI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">environments</span><span class="o">::</span><span class="n">pendulum</span><span class="o">::</span><span class="n">ui</span><span class="o">::</span><span class="n">xeus</span><span class="o">::</span><span class="n">UI</span><span class="o">&lt;</span><span class="n">UI_SPEC</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>We declare it and give the canvas as the output value of the cell (last statement) to be displayed:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">UI</span><span class="w"> </span><span class="n">ui</span><span class="p">;</span>
<span class="n">ui</span><span class="p">.</span><span class="n">canvas</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f31a209ea1c44fb9bc1fc050a403a329", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>We can now pass this UI to the <code class="docutils literal notranslate"><span class="pre">rlt::evaluate</span></code> function which populates it with the state and renders it into the displayed canvas:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">evaluate</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">envs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ui</span><span class="p">,</span><span class="w"> </span><span class="n">actor_critic</span><span class="p">.</span><span class="n">actor</span><span class="p">,</span><span class="w"> </span><span class="n">rlt</span><span class="o">::</span><span class="n">rl</span><span class="o">::</span><span class="n">utils</span><span class="o">::</span><span class="n">evaluation</span><span class="o">::</span><span class="n">Specification</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">EPISODE_STEP_LIMIT</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">observations_mean</span><span class="p">,</span><span class="w"> </span><span class="n">observations_std</span><span class="p">,</span><span class="w"> </span><span class="n">actor_buffer_eval</span><span class="p">,</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>The simulation runs in the kernel and pushes updates to the notebook, hence depending on the network speed the maximum playback speed might be less than realtime. The indicator at the bottom shows how much torque is applied to the joint by the policy. You can re-run this cell to run another episode with a different, random initial state.</p>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="07-The%20Loop%20Interface.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">The Loop Interface</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="05-MNIST%20Classification.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">MNIST Classification</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>